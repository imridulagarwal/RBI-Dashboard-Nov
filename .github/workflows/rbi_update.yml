name: RBI Monthly Update

on:
  workflow_dispatch: {}
  schedule:
    - cron: '15 2 15 * *'  # monthly; adjust as needed

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # allow committing JSON back to repo

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas openpyxl playwright

      # Install Playwright browsers + required OS dependencies (fixes your error)
      - name: Install Playwright browsers and system deps
        run: |
          python -m playwright install --with-deps chromium

      - name: Download latest RBI Excel (headless Playwright Python)
        id: download
        run: |
          python - <<'PY'
          import os, re, calendar, datetime as dt
          from pathlib import Path
          from playwright.sync_api import sync_playwright

          DL = Path("downloads"); DL.mkdir(exist_ok=True)

          with sync_playwright() as p:
              browser = p.chromium.launch(headless=True)
              context = browser.new_context(accept_downloads=True)
              page = context.new_page()
              page.goto("https://rbi.org.in/Scripts/ATMView.aspx", timeout=120000)

              # Click the first "Bank-wise ATM/POS/Card Statistics - <Month Year>" link
              link = page.get_by_role("link", name=re.compile("Bank-wise ATM/POS/Card Statistics", re.I)).first
              link.click()

              # Click the Excel download link
              with page.expect_download() as dl_info:
                  page.get_by_role("link", name=re.compile("Excel", re.I)).click()
              download = dl_info.value
              dest = DL / download.suggested_filename
              download.save_as(str(dest))

              # Try to read Month/Year from the page; fallback to previous month
              txt = page.inner_text("body")
              m = re.search(r"Month of\s+([A-Za-z]+)\s+(\d{4})", txt) or re.search(r"([A-Za-z]+)\s+(\d{4})", txt)
              if m:
                  month_name, year = m.group(1).capitalize(), int(m.group(2))
                  month = list(calendar.month_name).index(month_name)
              else:
                  today = dt.date.today(); first = today.replace(day=1); prev = first - dt.timedelta(days=1)
                  year, month = prev.year, prev.month

              print(f"XLSX_PATH={dest}")
              print(f"YEAR={year}")
              print(f"MONTH={month}")

              # Pass values to next steps
              github_output = os.environ['GITHUB_OUTPUT']
              with open(github_output,'a') as f:
                  f.write(f"XLSX_PATH={dest}\n")
                  f.write(f"YEAR={year}\n")
                  f.write(f"MONTH={month}\n")
          PY

      - name: Emit JSON into docs/data
        run: |
          python tools/emit_json.py "${{ steps.download.outputs.XLSX_PATH }}" "${{ steps.download.outputs.YEAR }}" "${{ steps.download.outputs.MONTH }}"

      - name: Commit JSON
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add docs/data/*.json
          git commit -m "RBI data update" || echo "No changes"
          git push
