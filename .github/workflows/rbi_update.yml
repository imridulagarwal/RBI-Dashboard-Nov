      - name: Download latest RBI Excel (headless Playwright Python)
        id: download
        run: |
          python - <<'PY'
          import os, calendar, datetime as dt, re
          from pathlib import Path
          from playwright.sync_api import sync_playwright, TimeoutError as PWTimeout

          DL = Path("downloads"); DL.mkdir(exist_ok=True)

          def pick_year_month_from_text(txt: str):
              m = re.search(r"Month of\s+([A-Za-z]+)\s+(\d{4})", txt) or re.search(r"([A-Za-z]+)\s+(\d{4})", txt)
              if m:
                  month_name, year = m.group(1).capitalize(), int(m.group(2))
                  month = list(calendar.month_name).index(month_name)
                  if month == 0:  # failed to map
                      raise ValueError("Could not map month name")
                  return year, month
              # fallback: previous month
              today = dt.date.today()
              first = today.replace(day=1)
              prev = first - dt.timedelta(days=1)
              return prev.year, prev.month

          with sync_playwright() as p:
              browser = p.chromium.launch(headless=True)
              context = browser.new_context(accept_downloads=True)
              page = context.new_page()
              page.set_default_timeout(120_000)

              page.goto("https://rbi.org.in/Scripts/ATMView.aspx", timeout=120000)
              page.wait_for_load_state("domcontentloaded")

              # ---- Robust link selection (NO regex role selectors) ----
              # Try text locator first
              try:
                  page.locator("a:has-text('Bank-wise ATM/POS/Card Statistics')").first.click()
              except PWTimeout:
                  # Fallback: find any anchor that looks like the monthly item
                  candidates = page.locator("a").all()
                  clicked = False
                  for i, a in enumerate(candidates):
                      try:
                          t = a.inner_text().strip()
                      except Exception:
                          continue
                      if "Bank-wise ATM/POS/Card Statistics" in t:
                          a.click()
                          clicked = True
                          break
                  if not clicked:
                      raise RuntimeError("Could not find the monthly 'Bank-wise ATM/POS/Card Statistics' link")

              # We should now be on the month page
              page.wait_for_load_state("domcontentloaded")

              # ---- Download Excel: try text('Excel') first; fallback to direct XLSX href ----
              download = None
              try:
                  with page.expect_download() as dl_info:
                      page.locator("a:has-text('Excel')").first.click()
                  download = dl_info.value
              except Exception:
                  # Fallback: click first .XLSX link
                  a_xlsx = page.locator("a[href$='.XLSX'], a[href$='.xlsx']").first
                  with page.expect_download() as dl_info:
                      a_xlsx.click()
                  download = dl_info.value

              dest = DL / download.suggested_filename
              download.save_as(str(dest))

              # Derive year/month from page text, else fallback
              txt = page.inner_text("body")
              year, month = pick_year_month_from_text(txt)

              print(f"XLSX_PATH={dest}")
              print(f"YEAR={year}")
              print(f"MONTH={month}")

              # Pass outputs to next steps
              with open(os.environ['GITHUB_OUTPUT'],'a') as f:
                  f.write(f"XLSX_PATH={dest}\n")
                  f.write(f"YEAR={year}\n")
                  f.write(f"MONTH={month}\n")
          PY
